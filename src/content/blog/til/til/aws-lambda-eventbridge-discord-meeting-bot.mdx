---
title: "AWS Lambda + EventBridge Scheduler로 Discord 회의 알리미 봇 만들기 (/meeting end 완성)"
date: 2026-01-25
summary: "슬래시 명령어로 회의를 등록하면 즉시 공지와 30분 전 리마인더가 자동으로 나가는 Discord 회의 알리미를 AWS Lambda + EventBridge Scheduler로 구성했다."
tags: ["AWS", "Lambda", "EventBridge Scheduler", "Discord", "Serverless", "Backend"]
category: "til"
series: "Today I Learned"
---

# AWS Lambda + EventBridge Scheduler로 Discord 회의 알리미 봇 만들기 (/meeting end 완성)

회의 일정이 불규칙해서, 디스코드 슬래시 명령어로 회의를 등록하면 **즉시 공지 + 다음 회의까지 할 일 기록 + 30분 전 리마인더**가 자동으로 되게 만들었다.  
아래는 `/meeting end` 명령을 기준으로 정리한 전체 설계와 구현 포인트다.

---

## 목표

- `/meeting schedule`: 특정 시간(예: 30분 전) 리마인더 예약
- `/meeting end`: 회의 종료 후 **다음 회의 등록 + 즉시 공지 + 30분 전 재공지 예약**

---

## 전체 아키텍처 개요

### 구성 요소

- **Discord Slash Command**
  - `/meeting schedule`
  - `/meeting end`
- **Lambda 3개**
  - `interactions-handler`: 서명 검증 + defer 응답 + 워커 비동기 호출
  - `interactions-worker`: 실제 비즈니스 로직 처리
  - `reminder-sender`: 디스코드 Webhook으로 메시지 발송
- **EventBridge Scheduler**
  - `at()` 스케줄로 **딱 한 번** `reminder-sender` 실행

---

## 왜 Lambda를 3개로 나눴나?

Discord Interactions는 **3초 안에 응답**해야 한다.  
스케줄 생성, 권한 체크, 외부 호출(fetch), SDK 호출 등이 섞이면 쉽게 타임아웃이 난다.

그래서:

- `handler`는 **서명 검증 + 워커 비동기 호출 + defer 응답(type 5)** 만 수행
- 무거운 로직은 `worker`로 분리
- 실제 메시지 전송은 `reminder-sender`로 분리

---

## `/meeting end` 동작 흐름

1. 사용자가 `/meeting end` 실행  
   - 입력: `next_time`, `next_title`, `tasks`, `link`, `before(기본 30)`
2. `interactions-handler`
   - 서명 검증
   - 워커 Lambda **async invoke**
   - 바로 defer 응답(type: 5) 반환
3. `interactions-worker`
   - (A) 즉시 공지: `reminder-sender` 직접 invoke
   - (B) 재공지 예약: EventBridge Scheduler에 **30분 전 at() 스케줄** 생성
   - (C) 디스코드 UI에서 “생각중…”이 끝나도록 **원본 응답 수정**
4. Scheduler가 정해진 시간에 `reminder-sender` 실행 → 리마인더 발송

---

## 핵심 구현 포인트

### 1) Discord 응답은 follow-up 대신 **@original 수정**

`defer(type 5)` 이후 처리 완료를 알릴 때, follow-up 대신 **원본 응답 수정**이 안정적이었다.

```http
PATCH /webhooks/{application_id}/{interaction_token}/messages/@original
```

이 방식으로 “생각중…” 메시지가 정상적으로 “완료”로 바뀐다.

---

### 2) EventBridge Scheduler는 단발성 `at()` 스케줄

다음 회의 30분 전 한 번만 실행되도록 스케줄을 만든다.

- `ScheduleExpression`: `at(2025-03-08T10:30:00)`
- Target: `reminder-sender` Lambda

---

### 3) 즉시 공지는 Lambda 직접 invoke

Scheduler를 기다리지 않고, `interactions-worker`가 `reminder-sender`를 **직접 invoke**해서 즉시 공지를 보낸다.

---

## 환경 변수 정리

### reminder-sender

- `DISCORD_WEBHOOK_URL`: 메시지 발송 채널 Webhook URL

### interactions-handler

- `DISCORD_PUBLIC_KEY`: Discord App Public Key (서명 검증)
- `WORKER_FUNCTION_NAME`: `interactions-worker` 함수명 또는 ARN

### interactions-worker

- `REMINDER_LAMBDA_ARN`: Scheduler Target용 `reminder-sender` ARN
- `SCHEDULER_ROLE_ARN`: Scheduler가 Lambda 호출할 때 사용할 Role ARN
- `REMINDER_FUNCTION`: 즉시 공지용 `reminder-sender` 함수명 또는 ARN

---

## IAM 권한 구성 (가장 많이 막힌 부분)

### interactions-handler 실행 Role

- `lambda:InvokeFunction` → `interactions-worker`

### interactions-worker 실행 Role

- `scheduler:CreateSchedule` (필요 시 Update/Delete/Get)
- `iam:PassRole` → `SCHEDULER_ROLE_ARN`
- `lambda:InvokeFunction` → `reminder-sender`
- CloudWatch Logs 권한

### Scheduler 실행 Role (= `SCHEDULER_ROLE_ARN`)

- `lambda:InvokeFunction` → `reminder-sender`

---

## 트러블슈팅

### 1) “애플리케이션이 응답하지 않았어요”

- 원인: worker에서 follow-up 호출 실패로 Discord UI가 정상 완료되지 않음
- 해결: follow-up 대신 **@original 수정 방식**으로 변경

### 2) followUp failed: 404 Unknown Webhook (code 10015)

- 원인: defer 이후 follow-up 토큰/엔드포인트 처리 불안정
- 해결: `PATCH /webhooks/{application_id}/{interaction_token}/messages/@original`

### 3) CreateSchedule error: AccessDeniedException iam:PassRole

- 원인: worker 실행 Role에 PassRole 권한 누락 또는 ARN 오타
- 해결: `iam:PassRole`을 `SCHEDULER_ROLE_ARN`에 정확히 허용

### 4) AccessDeniedException: lambda:InvokeFunction on reminder-sender

- 원인: worker 실행 Role에 invoke 권한 누락
- 해결: `lambda:InvokeFunction` 추가

```json
{
  "Effect": "Allow",
  "Action": "lambda:InvokeFunction",
  "Resource": [
    "arn:aws:lambda:ap-northeast-2:820178563984:function:reminder-sender",
    "arn:aws:lambda:ap-northeast-2:820178563984:function:reminder-sender:*"
  ]
}
```

---

## UX 개선

- `link`가 `no` 같은 값이면 null 처리
- `tasks` 문자열의 `\\n`을 실제 줄바꿈으로 변환: `replace(/\\n/g, "\n")`

---

## 결과

- `/meeting end` 실행 시 즉시 채널 공지 ✅
- 다음 회의까지 할 일(tasks) 함께 공지 ✅
- 지정 시간(before=30) 전 재공지 스케줄 생성 ✅
- 디스코드에서 “응답 없음” 없이 정상 완료 표시 ✅

---

## 다음 개선 아이디어

- DynamoDB에 “다음 회의 정보” 저장
  - `/meeting show`: 다음 회의 조회
  - `/meeting cancel`: 예약 취소
  - `/meeting list`: 스케줄 목록 조회
- tasks를 체크리스트 형태로 파싱해 더 예쁘게 출력
- 에러 발생 시에도 최소 기능(스케줄만이라도 등록)이 되도록 try/catch로 부분 실패 허용
