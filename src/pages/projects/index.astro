---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// Get all published projects
const allProjects = (await getCollection('projects', ({ data }) => !data.draft))
  .sort((a, b) => a.data.order - b.data.order);

// Extract unique tags from stack
const allTags = [...new Set(allProjects.flatMap((p) => p.data.stack))].sort();

// Prepare projects data for client-side filtering
const projectsData = allProjects.map(project => ({
  slug: project.slug,
  title: project.data.title,
  period: project.data.period,
  role: project.data.role,
  stack: project.data.stack,
  highlights: project.data.highlights,
  metrics: project.data.metrics,
  cover: project.data.cover,
  youtube: project.data.youtube,
}));
---

<BaseLayout 
  title="프로젝트"
  description="주요 프로젝트 목록입니다. 백엔드 아키텍처, 인프라 자동화, 성능 최적화 등의 경험을 확인하세요."
>
  <section class="section">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">프로젝트</h1>
        <p class="page-desc">
          문제 해결 과정과 성과를 중심으로 정리한 프로젝트입니다.
        </p>
      </header>

      <!-- Tag Filter -->
      <div class="tag-filter">
        <div class="filter-header">
          <span class="filter-label">기술 스택 필터</span>
          <button class="clear-filter" id="clear-filter" style="display: none;">초기화</button>
        </div>
        
        <div class="tag-list" id="tag-list">
          <button class="tag-btn active" data-tag="">전체</button>
          {allTags.map((tag) => (
            <button class="tag-btn" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>

      <!-- Projects Grid -->
      <div class="projects-grid" id="projects-grid">
        {allProjects.map((project) => (
          <article class="project-card" data-stack={project.data.stack.join(',')}>
            <a href={`/projects/${project.slug}`} class="card-link">
              {project.data.cover && (
                <div class="card-cover">
                  <img src={project.data.cover} alt={project.data.title} loading="lazy" />
                </div>
              )}
              {project.data.youtube && !project.data.cover && (
                <div class="card-cover youtube-cover">
                  <img 
                    src={`https://img.youtube.com/vi/${project.data.youtube}/maxresdefault.jpg`} 
                    alt={project.data.title}
                    loading="lazy"
                  />
                  <div class="play-icon">▶</div>
                </div>
              )}
              <div class="card-content">
                <h2 class="card-title">{project.data.title}</h2>
                <div class="card-meta">
                  <span class="card-period">{project.data.period}</span>
                  <span class="card-role">{project.data.role}</span>
                </div>
                
                {project.data.highlights.length > 0 && (
                  <ul class="card-highlights">
                    {project.data.highlights.slice(0, 2).map((highlight) => (
                      <li>{highlight}</li>
                    ))}
                  </ul>
                )}

                {project.data.metrics.length > 0 && (
                  <div class="card-metrics">
                    {project.data.metrics.slice(0, 2).map((metric) => (
                      <span class="metric">{metric}</span>
                    ))}
                  </div>
                )}

                <div class="card-stack">
                  {project.data.stack.slice(0, 5).map((tech) => (
                    <span class="tech-tag">{tech}</span>
                  ))}
                  {project.data.stack.length > 5 && (
                    <span class="tech-more">+{project.data.stack.length - 5}</span>
                  )}
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <p>해당 기술 스택의 프로젝트가 없습니다.</p>
        <button id="reset-filter">전체 프로젝트 보기</button>
      </div>
    </div>
  </section>
</BaseLayout>

<!-- Client-side JavaScript for filtering -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let currentTag = '';
    
    // DOM Elements
    const tagList = document.getElementById('tag-list');
    const clearFilter = document.getElementById('clear-filter');
    const resetFilter = document.getElementById('reset-filter');
    const projectsGrid = document.getElementById('projects-grid');
    const emptyState = document.getElementById('empty-state');
    const projectCards = projectsGrid?.querySelectorAll('.project-card');

    // Read URL param on load
    const urlParams = new URLSearchParams(window.location.search);
    const tagParam = urlParams.get('tag');
    if (tagParam) {
      currentTag = tagParam;
      applyFilter();
    }

    // Tag filter click
    tagList?.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.classList.contains('tag-btn')) {
        currentTag = target.dataset.tag || '';
        applyFilter();
      }
    });

    // Clear filter
    clearFilter?.addEventListener('click', () => {
      currentTag = '';
      applyFilter();
    });

    resetFilter?.addEventListener('click', () => {
      currentTag = '';
      applyFilter();
    });

    function applyFilter() {
      // Update URL
      const newUrl = currentTag ? `/projects?tag=${encodeURIComponent(currentTag)}` : '/projects';
      window.history.replaceState({}, '', newUrl);

      // Update tag buttons
      tagList?.querySelectorAll('.tag-btn').forEach(btn => {
        const btnTag = (btn as HTMLElement).dataset.tag || '';
        btn.classList.toggle('active', btnTag === currentTag);
      });

      // Show/hide clear button
      if (clearFilter) {
        clearFilter.style.display = currentTag ? 'block' : 'none';
      }

      // Filter projects
      let visibleCount = 0;
      projectCards?.forEach(card => {
        const cardElement = card as HTMLElement;
        const stack = cardElement.dataset.stack?.split(',') || [];
        const shouldShow = !currentTag || stack.includes(currentTag);
        
        cardElement.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
      });

      // Show empty state if no results
      if (projectsGrid && emptyState) {
        projectsGrid.style.display = visibleCount > 0 ? 'grid' : 'none';
        emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
      }
    }
  });
</script>

<style>
  .section {
    padding: var(--space-12) 0 var(--space-20);
  }

  .page-header {
    margin-bottom: var(--space-8);
  }

  .page-title {
    font-size: var(--text-4xl);
    font-weight: 700;
    margin-bottom: var(--space-4);
  }

  .page-desc {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Tag Filter */
  .tag-filter {
    margin-bottom: var(--space-6);
  }

  .filter-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
  }

  .filter-label {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
  }

  .clear-filter {
    font-size: var(--text-sm);
    color: var(--color-accent);
    background: none;
    border: none;
    cursor: pointer;
  }

  .clear-filter:hover {
    text-decoration: underline;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tag-btn {
    font-size: var(--text-sm);
    padding: var(--space-2) var(--space-3);
    background-color: var(--color-bg-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .tag-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .tag-btn.active {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  /* Projects Grid */
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: var(--space-6);
  }

  /* Project Card */
  .project-card {
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-fast);
  }

  .project-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
  }

  .card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .card-cover {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    background-color: var(--color-bg);
  }

  .card-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .project-card:hover .card-cover img {
    transform: scale(1.05);
  }

  .youtube-cover {
    position: relative;
  }

  .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    transition: background-color var(--transition-fast);
  }

  .project-card:hover .play-icon {
    background-color: var(--color-accent);
  }

  .card-content {
    padding: var(--space-5);
  }

  .card-title {
    font-size: var(--text-xl);
    font-weight: 600;
    margin: 0 0 var(--space-2);
    line-height: 1.3;
  }

  .card-meta {
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .card-period {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .card-role {
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-accent-light);
    color: var(--color-accent);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 500;
  }

  .card-highlights {
    list-style: none;
    padding: 0;
    margin: 0 0 var(--space-3);
  }

  .card-highlights li {
    position: relative;
    padding-left: var(--space-4);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: 1.6;
  }

  .card-highlights li::before {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--color-accent);
  }

  .card-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }

  .metric {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    background-color: #dcfce7;
    color: #166534;
    border-radius: var(--radius-sm);
    font-weight: 500;
  }

  @media (prefers-color-scheme: dark) {
    .metric {
      background-color: #14532d;
      color: #86efac;
    }
  }

  .card-stack {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tech-tag {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-bg);
    color: var(--color-text-muted);
    border-radius: var(--radius-sm);
  }

  .tech-more {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    color: var(--color-text-muted);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-16) 0;
    color: var(--color-text-muted);
  }

  .empty-state button {
    color: var(--color-accent);
    background: none;
    border: none;
    cursor: pointer;
    margin-top: var(--space-4);
    font-size: var(--text-base);
  }

  .empty-state button:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .projects-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
