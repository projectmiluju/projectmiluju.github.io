---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import { siteConfig } from '../../config/site';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const { title, date, summary, tags, category, series } = post.data;

const categoryLabels: Record<string, string> = {
  cs: 'CS Notes',
  book: 'Book Notes',
  til: 'TIL',
};

const formattedDate = date.toLocaleDateString('ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Get prev/next posts
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

// Get related posts (same category or tags)
const relatedPosts = allPosts
  .filter((p) => p.slug !== post.slug)
  .filter((p) => 
    p.data.category === category ||
    p.data.tags.some((t) => tags.includes(t))
  )
  .slice(0, 3);
---

<BaseLayout
  title={title}
  description={summary}
  ogType="article"
>
  <article class="blog-post">
    <div class="container">
      <!-- Header -->
      <header class="post-header">
        <a href="/blog" class="back-link">← 블로그 목록</a>
        
        <div class="post-meta">
          <a 
            href={`/blog?category=${category}`} 
            class="category-badge"
            data-category={category}
          >
            {categoryLabels[category] || category}
          </a>
          <time datetime={date.toISOString()}>{formattedDate}</time>
        </div>

        <h1 class="post-title">{title}</h1>
        
        <p class="post-summary">{summary}</p>

        {tags.length > 0 && (
          <div class="post-tags">
            {tags.map((tag) => (
              <a href={`/blog?tag=${encodeURIComponent(tag)}`} class="tag">
                #{tag}
              </a>
            ))}
          </div>
        )}
      </header>

      <!-- Content -->
      <div class="post-layout">
        <aside class="post-sidebar">
          <TableOfContents headings={headings} />
        </aside>

        <div class="post-content prose">
          <Content />
        </div>
      </div>

      <!-- Navigation -->
      <nav class="post-navigation" aria-label="이전/다음 글">
        <div class="nav-item nav-prev">
          {prevPost && (
            <>
              <span class="nav-label">이전 글</span>
              <a href={`/blog/${prevPost.slug}`} class="nav-link">
                ← {prevPost.data.title}
              </a>
            </>
          )}
        </div>
        <div class="nav-item nav-next">
          {nextPost && (
            <>
              <span class="nav-label">다음 글</span>
              <a href={`/blog/${nextPost.slug}`} class="nav-link">
                {nextPost.data.title} →
              </a>
            </>
          )}
        </div>
      </nav>

      <!-- Related Posts -->
      {relatedPosts.length > 0 && (
        <section class="related-posts">
          <h2 class="related-title">관련 글</h2>
          <ul class="related-list">
            {relatedPosts.map((p) => (
              <li>
                <a href={`/blog/${p.slug}`} class="related-link">
                  <span class="related-category" data-category={p.data.category}>
                    {categoryLabels[p.data.category]}
                  </span>
                  <span class="related-post-title">{p.data.title}</span>
                </a>
              </li>
            ))}
          </ul>
        </section>
      )}

      <!-- Giscus Comments (Optional) -->
      <!--
      <section class="comments">
        <h2 class="comments-title">댓글</h2>
        <script 
          src="https://giscus.app/client.js"
          data-repo="projectmiluju/projectmiluju.github.io"
          data-repo-id="YOUR_REPO_ID"
          data-category="Comments"
          data-category-id="YOUR_CATEGORY_ID"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="top"
          data-theme="preferred_color_scheme"
          data-lang="ko"
          crossorigin="anonymous"
          async>
        </script>
      </section>
      -->
    </div>
  </article>
</BaseLayout>

<style>
  .blog-post {
    padding: var(--space-8) 0 var(--space-20);
  }

  .back-link {
    display: inline-block;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-decoration: none;
    margin-bottom: var(--space-6);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .post-header {
    max-width: var(--content-width);
    margin-bottom: var(--space-10);
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .category-badge {
    font-size: var(--text-xs);
    font-weight: 500;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    text-decoration: none;
    background-color: var(--color-accent-light);
    color: var(--color-accent);
  }

  .category-badge[data-category="cs"] {
    background-color: #e0f2fe;
    color: #0369a1;
  }

  .category-badge[data-category="book"] {
    background-color: #fef3c7;
    color: #b45309;
  }

  .category-badge[data-category="til"] {
    background-color: #fee2e2;
    color: #dc2626;
  }

  @media (prefers-color-scheme: dark) {
    .category-badge[data-category="cs"] {
      background-color: #0c4a6e;
      color: #7dd3fc;
    }

    .category-badge[data-category="book"] {
      background-color: #78350f;
      color: #fcd34d;
    }

    .category-badge[data-category="til"] {
      background-color: #7f1d1d;
      color: #fca5a5;
    }
  }

  .post-meta time {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .post-title {
    font-size: var(--text-4xl);
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: var(--space-4);
  }

  .post-summary {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .tag {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .tag:hover {
    color: var(--color-accent);
  }

  /* Layout */
  .post-layout {
    display: grid;
    grid-template-columns: 1fr var(--sidebar-width);
    gap: var(--space-10);
    align-items: start;
  }

  .post-sidebar {
    order: 2;
  }

  .post-content {
    order: 1;
    max-width: var(--content-width);
  }

  /* Prose Styles */
  .prose h2 {
    font-size: var(--text-2xl);
    font-weight: 600;
    margin-top: var(--space-10);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border);
  }

  .prose h3 {
    font-size: var(--text-xl);
    font-weight: 600;
    margin-top: var(--space-8);
    margin-bottom: var(--space-3);
  }

  .prose h4 {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-top: var(--space-6);
    margin-bottom: var(--space-2);
  }

  .prose p {
    margin-bottom: var(--space-4);
  }

  .prose ul, .prose ol {
    margin-bottom: var(--space-4);
  }

  .prose img {
    border-radius: var(--radius-md);
    margin: var(--space-6) 0;
  }

  /* Navigation */
  .post-navigation {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
    margin-top: var(--space-16);
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-border);
    max-width: var(--content-width);
  }

  .nav-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .nav-link {
    font-size: var(--text-sm);
    color: var(--color-text);
    text-decoration: none;
    transition: color var(--transition-fast);
    line-height: 1.4;
  }

  .nav-link:hover {
    color: var(--color-accent);
  }

  /* Related Posts */
  .related-posts {
    margin-top: var(--space-12);
    padding: var(--space-6);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    max-width: var(--content-width);
  }

  .related-title {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-bottom: var(--space-4);
  }

  .related-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .related-list li {
    margin-bottom: var(--space-3);
  }

  .related-list li:last-child {
    margin-bottom: 0;
  }

  .related-link {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    color: var(--color-text);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .related-link:hover {
    color: var(--color-accent);
  }

  .related-category {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    white-space: nowrap;
  }

  .related-category[data-category="cs"] {
    background-color: #e0f2fe;
    color: #0369a1;
  }

  .related-category[data-category="book"] {
    background-color: #fef3c7;
    color: #b45309;
  }

  .related-category[data-category="til"] {
    background-color: #fee2e2;
    color: #dc2626;
  }

  @media (prefers-color-scheme: dark) {
    .related-category[data-category="cs"] {
      background-color: #0c4a6e;
      color: #7dd3fc;
    }

    .related-category[data-category="book"] {
      background-color: #78350f;
      color: #fcd34d;
    }

    .related-category[data-category="til"] {
      background-color: #7f1d1d;
      color: #fca5a5;
    }
  }

  .related-post-title {
    font-size: var(--text-sm);
  }

  /* Comments */
  .comments {
    margin-top: var(--space-12);
    max-width: var(--content-width);
  }

  .comments-title {
    font-size: var(--text-lg);
    font-weight: 600;
    margin-bottom: var(--space-4);
  }

  @media (max-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr;
    }

    .post-sidebar {
      display: none;
    }

    .post-content {
      max-width: none;
    }

    .post-navigation,
    .related-posts,
    .comments {
      max-width: none;
    }
  }

  @media (max-width: 768px) {
    .post-title {
      font-size: var(--text-3xl);
    }

    .post-navigation {
      grid-template-columns: 1fr;
    }

    .nav-next {
      text-align: left;
    }
  }
</style>
