---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { siteConfig } from '../../config/site';

// Get all published posts
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Extract unique tags
const allTags = [...new Set(allPosts.flatMap((p) => p.data.tags))];

// Get filters from URL
const url = Astro.url;
const currentTag = url.searchParams.get('tag') || undefined;
const currentCategory = url.searchParams.get('category') || undefined;
const currentSeries = url.searchParams.get('series') || undefined;
const searchQuery = url.searchParams.get('q') || undefined;

// Filter posts
let posts = allPosts;

if (currentCategory) {
  posts = posts.filter((p) => p.data.category === currentCategory);
}

if (currentSeries) {
  posts = posts.filter((p) => p.data.series === currentSeries);
}

if (currentTag) {
  posts = posts.filter((p) => p.data.tags.includes(currentTag));
}

if (searchQuery) {
  const query = searchQuery.toLowerCase();
  posts = posts.filter((p) => 
    p.data.title.toLowerCase().includes(query) ||
    p.data.summary.toLowerCase().includes(query) ||
    p.data.tags.some((t) => t.toLowerCase().includes(query))
  );
}

// Group posts by series for display when no filter is active
const postsBySeries = allPosts.reduce((acc, post) => {
  const series = post.data.series || '기타';
  if (!acc[series]) {
    acc[series] = [];
  }
  acc[series].push(post);
  return acc;
}, {} as Record<string, typeof allPosts>);

// Get series info from config
const getSeriesInfo = (seriesName: string) => {
  return siteConfig.blogSeries.find(s => s.slug === seriesName);
};

// Check if showing grouped view (no filters applied)
const showGroupedView = !currentCategory && !currentSeries && !currentTag && !searchQuery;
---

<BaseLayout 
  title="블로그"
  description="CS 개념 정리, 개발 서적 리뷰, 트러블슈팅 경험을 기록합니다."
>
  <section class="section">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">블로그</h1>
        <p class="page-desc">
          CS 개념 정리, 개발 서적 리뷰, 트러블슈팅 경험을 기록합니다.
        </p>
      </header>

      <!-- Search -->
      <div class="search-box">
        <form action="/blog" method="get" class="search-form">
          <input 
            type="search" 
            name="q" 
            placeholder="검색어를 입력하세요..."
            value={searchQuery || ''}
            class="search-input"
          />
          <button type="submit" class="search-btn" aria-label="검색">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </button>
        </form>
      </div>

      <!-- Category Filter -->
      <div class="category-filter">
        <a 
          href="/blog" 
          class:list={['category-btn', { active: !currentCategory && !currentSeries }]}
        >
          전체
        </a>
        {siteConfig.blogCategories.map((cat) => (
          <a 
            href={`/blog?category=${cat.slug}`}
            class:list={['category-btn', { active: currentCategory === cat.slug && !currentSeries }]}
          >
            {cat.name}
          </a>
        ))}
      </div>

      <!-- Series Filter (Sub-categories) -->
      <div class="series-filter">
        <span class="filter-label">시리즈</span>
        <div class="series-list">
          {siteConfig.blogSeries.map((series) => (
            <a 
              href={`/blog?series=${encodeURIComponent(series.slug)}`}
              class:list={['series-btn', { active: currentSeries === series.slug }]}
              data-category={series.category}
            >
              <span class="series-icon">{series.icon}</span>
              <span class="series-name">{series.name}</span>
              <span class="series-count">
                {postsBySeries[series.slug]?.length || 0}
              </span>
            </a>
          ))}
        </div>
      </div>

      <!-- Tag Filter -->
      {allTags.length > 0 && (
        <div class="tag-filter">
          <span class="filter-label">태그</span>
          <div class="tag-list">
            {currentTag && (
              <a href="/blog" class="tag-item active">
                {currentTag} ×
              </a>
            )}
            {!currentTag && allTags.slice(0, 10).map((tag) => (
              <a href={`/blog?tag=${encodeURIComponent(tag)}`} class="tag-item">
                #{tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Active Filters Display -->
      {(currentCategory || currentSeries || currentTag || searchQuery) && (
        <div class="active-filters">
          <span>필터 적용 중:</span>
          {currentCategory && (
            <span class="filter-badge">
              카테고리: {siteConfig.blogCategories.find(c => c.slug === currentCategory)?.name}
            </span>
          )}
          {currentSeries && (
            <span class="filter-badge">
              시리즈: {currentSeries}
            </span>
          )}
          {currentTag && <span class="filter-badge">태그: {currentTag}</span>}
          {searchQuery && <span class="filter-badge">검색: "{searchQuery}"</span>}
          <a href="/blog" class="clear-all">모두 초기화</a>
        </div>
      )}

      {/* Posts Display */}
      {showGroupedView ? (
        <div class="series-sections">
          {Object.entries(postsBySeries)
            .sort(([a], [b]) => {
              const aIndex = siteConfig.blogSeries.findIndex(s => s.slug === a);
              const bIndex = siteConfig.blogSeries.findIndex(s => s.slug === b);
              if (aIndex === -1 && bIndex === -1) return 0;
              if (aIndex === -1) return 1;
              if (bIndex === -1) return -1;
              return aIndex - bIndex;
            })
            .map(([seriesName, seriesPosts]) => {
              const seriesInfo = getSeriesInfo(seriesName);
              return (
                <section class="series-section" data-category={seriesInfo?.category}>
                  <div class="series-header">
                    <h2 class="series-title">
                      {seriesInfo?.icon && <span class="series-icon">{seriesInfo.icon}</span>}
                      {seriesName}
                    </h2>
                    <span class="series-meta">
                      <span class="post-count">{seriesPosts.length}개의 글</span>
                      <a href={`/blog?series=${encodeURIComponent(seriesName)}`} class="view-all">
                        전체 보기 →
                      </a>
                    </span>
                  </div>
                  <div class="series-posts">
                    {seriesPosts.slice(0, 4).map((post) => (
                      <BlogCard
                        title={post.data.title}
                        slug={post.slug}
                        date={post.data.date}
                        summary={post.data.summary}
                        category={post.data.category}
                        tags={post.data.tags}
                      />
                    ))}
                  </div>
                </section>
              );
            })}
        </div>
      ) : posts.length > 0 ? (
        <div class="blog-grid">
          {posts.map((post) => (
            <BlogCard
              title={post.data.title}
              slug={post.slug}
              date={post.data.date}
              summary={post.data.summary}
              category={post.data.category}
              tags={post.data.tags}
            />
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <p>검색 결과가 없습니다.</p>
          <a href="/blog">전체 글 보기</a>
        </div>
      )}
    </div>
  </section>
</BaseLayout>

<style>
  .section {
    padding: var(--space-12) 0 var(--space-20);
  }

  .page-header {
    margin-bottom: var(--space-8);
  }

  .page-title {
    font-size: var(--text-4xl);
    font-weight: 700;
    margin-bottom: var(--space-4);
  }

  .page-desc {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Search */
  .search-box {
    margin-bottom: var(--space-6);
  }

  .search-form {
    display: flex;
    max-width: 400px;
  }

  .search-input {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-base);
    border: 1px solid var(--color-border);
    border-right: none;
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    background-color: var(--color-bg-alt);
    color: var(--color-text);
    outline: none;
  }

  .search-input:focus {
    border-color: var(--color-accent);
  }

  .search-btn {
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-accent);
    color: white;
    border: none;
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    cursor: pointer;
    transition: background-color var(--transition-fast);
  }

  .search-btn:hover {
    background-color: var(--color-accent-hover);
  }

  /* Category Filter */
  .category-filter {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
  }

  .category-btn {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .category-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .category-btn.active {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  /* Series Filter */
  .series-filter {
    margin-bottom: var(--space-6);
  }

  .filter-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
  }

  .series-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-3);
  }

  .series-btn {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    transition: all var(--transition-fast);
  }

  .series-btn:hover {
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  .series-btn.active {
    border-color: var(--color-accent);
    background-color: var(--color-accent-light);
  }

  .series-btn[data-category="cs"] .series-icon {
    color: #0369a1;
  }

  .series-btn[data-category="book"] .series-icon {
    color: #b45309;
  }

  .series-btn .series-icon {
    font-size: var(--text-lg);
  }

  .series-btn .series-name {
    flex: 1;
    font-size: var(--text-sm);
    font-weight: 500;
  }

  .series-btn .series-count {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    background-color: var(--color-bg);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
  }

  /* Tag Filter */
  .tag-filter {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }

  .tag-filter .filter-label {
    display: inline;
    margin-bottom: 0;
  }

  .tag-list {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .tag-item {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-decoration: none;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }

  .tag-item:hover {
    color: var(--color-accent);
    background-color: var(--color-accent-light);
  }

  .tag-item.active {
    background-color: var(--color-accent);
    color: white;
  }

  /* Active Filters */
  .active-filters {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-accent-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    font-size: var(--text-sm);
  }

  .filter-badge {
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-bg-alt);
    border-radius: var(--radius-sm);
  }

  .clear-all {
    color: var(--color-accent);
    text-decoration: none;
    margin-left: auto;
  }

  .clear-all:hover {
    text-decoration: underline;
  }

  /* Series Sections (Grouped View) */
  .series-sections {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
  }

  .series-section {
    padding: var(--space-6);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }

  .series-section[data-category="cs"] {
    border-left: 4px solid #0369a1;
  }

  .series-section[data-category="book"] {
    border-left: 4px solid #b45309;
  }

  .series-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .series-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xl);
    font-weight: 600;
    margin: 0;
  }

  .series-title .series-icon {
    font-size: var(--text-2xl);
  }

  .series-meta {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .post-count {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .view-all {
    font-size: var(--text-sm);
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 500;
  }

  .view-all:hover {
    text-decoration: underline;
  }

  .series-posts {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-4);
  }

  /* Grid */
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-6);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-16) 0;
    color: var(--color-text-muted);
  }

  .empty-state a {
    color: var(--color-accent);
    text-decoration: none;
    margin-top: var(--space-4);
    display: inline-block;
  }

  @media (max-width: 768px) {
    .blog-grid {
      grid-template-columns: 1fr;
    }

    .series-posts {
      grid-template-columns: 1fr;
    }

    .series-list {
      grid-template-columns: 1fr;
    }

    .search-form {
      max-width: none;
    }

    .series-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
