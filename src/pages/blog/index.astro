---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { siteConfig } from '../../config/site';

// Get all published posts
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Extract unique tags
const allTags = [...new Set(allPosts.flatMap((p) => p.data.tags))];

// Prepare posts data for client-side filtering
const postsData = allPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  date: post.data.date.toISOString(),
  summary: post.data.summary,
  category: post.data.category,
  tags: post.data.tags,
  series: post.data.series || '기타',
}));

// Group posts by series
const postsBySeries = allPosts.reduce((acc, post) => {
  const series = post.data.series || '기타';
  if (!acc[series]) {
    acc[series] = [];
  }
  acc[series].push(post);
  return acc;
}, {} as Record<string, typeof allPosts>);

const categoryLabels: Record<string, string> = {
  cs: 'CS Notes',
  book: 'Book Notes',
  til: 'TIL',
};
---

<BaseLayout 
  title="블로그"
  description="CS 개념 정리, 개발 서적 리뷰, TIL 경험을 기록합니다."
>
  <section class="section">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">블로그</h1>
        <p class="page-desc">
          CS 개념 정리, 개발 서적 리뷰, TIL 경험을 기록합니다.
        </p>
      </header>

      <!-- Search -->
      <div class="search-box">
        <div class="search-form">
          <input 
            type="search" 
            id="search-input"
            placeholder="검색어를 입력하세요..."
            class="search-input"
          />
          <button type="button" id="search-btn" class="search-btn" aria-label="검색">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Category Filter -->
      <div class="category-filter" id="category-filter">
        <button class="category-btn active" data-category="">전체</button>
        {siteConfig.blogCategories.map((cat) => (
          <button class="category-btn" data-category={cat.slug}>
            {cat.name}
          </button>
        ))}
      </div>

      <!-- Series Filter -->
      <div class="series-filter">
        <span class="filter-label">시리즈</span>
        <div class="series-list" id="series-filter">
          {siteConfig.blogSeries.map((series) => (
            <button 
              class="series-btn"
              data-series={series.slug}
              data-category={series.category}
            >
              <span class="series-icon">{series.icon}</span>
              <span class="series-name">{series.name}</span>
              <span class="series-count">
                {postsBySeries[series.slug]?.length || 0}
              </span>
            </button>
          ))}
        </div>
      </div>

      <!-- Tag Filter -->
      <div class="tag-filter" id="tag-filter">
        <span class="filter-label">태그</span>
        <div class="tag-list">
          {allTags.slice(0, 15).map((tag) => (
            <button class="tag-item" data-tag={tag}>
              #{tag}
            </button>
          ))}
        </div>
      </div>

      <!-- Active Filters Display -->
      <div class="active-filters" id="active-filters" style="display: none;">
        <span>필터 적용 중:</span>
        <div id="filter-badges"></div>
        <button class="clear-all" id="clear-filters">모두 초기화</button>
      </div>

      <!-- Posts Container -->
      <div id="posts-container">
        <!-- Grouped View (Default) -->
        <div class="series-sections" id="grouped-view">
          {siteConfig.blogSeries.map((seriesConfig) => {
            const seriesPosts = postsBySeries[seriesConfig.slug] || [];
            if (seriesPosts.length === 0) return null;
            
            return (
              <section class="series-section" data-category={seriesConfig.category} data-series-name={seriesConfig.slug}>
                <div class="series-header">
                  <h2 class="series-title">
                    <span class="series-icon">{seriesConfig.icon}</span>
                    {seriesConfig.name}
                  </h2>
                  <span class="series-meta">
                    <span class="post-count">{seriesPosts.length}개의 글</span>
                    <button class="view-all" data-series={seriesConfig.slug}>
                      전체 보기 →
                    </button>
                  </span>
                </div>
                <div class="series-posts">
                  {seriesPosts.slice(0, 4).map((post) => (
                    <article class="blog-card">
                      <a href={`/blog/${post.slug}`} class="card-link">
                        <div class="card-content">
                          <div class="card-meta">
                            <span class="card-category" data-category={post.data.category}>
                              {categoryLabels[post.data.category]}
                            </span>
                            <time datetime={post.data.date.toISOString()}>
                              {post.data.date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </time>
                          </div>
                          <h3 class="card-title">{post.data.title}</h3>
                          <p class="card-summary">{post.data.summary}</p>
                          <div class="card-tags">
                            {post.data.tags.slice(0, 3).map((tag) => (
                              <span class="card-tag">#{tag}</span>
                            ))}
                          </div>
                        </div>
                      </a>
                    </article>
                  ))}
                </div>
              </section>
            );
          })}
          
          {/* 기타 시리즈 */}
          {postsBySeries['기타'] && postsBySeries['기타'].length > 0 && (
            <section class="series-section" data-series-name="기타">
              <div class="series-header">
                <h2 class="series-title">기타</h2>
                <span class="series-meta">
                  <span class="post-count">{postsBySeries['기타'].length}개의 글</span>
                </span>
              </div>
              <div class="series-posts">
                {postsBySeries['기타'].slice(0, 4).map((post) => (
                  <article class="blog-card">
                    <a href={`/blog/${post.slug}`} class="card-link">
                      <div class="card-content">
                        <div class="card-meta">
                          <span class="card-category" data-category={post.data.category}>
                            {categoryLabels[post.data.category]}
                          </span>
                          <time datetime={post.data.date.toISOString()}>
                            {post.data.date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
                          </time>
                        </div>
                        <h3 class="card-title">{post.data.title}</h3>
                        <p class="card-summary">{post.data.summary}</p>
                        <div class="card-tags">
                          {post.data.tags.slice(0, 3).map((tag) => (
                            <span class="card-tag">#{tag}</span>
                          ))}
                        </div>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </section>
          )}
        </div>

        <!-- Filtered View (Hidden by default) -->
        <div class="blog-grid" id="filtered-view" style="display: none;"></div>
        
        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
          <p>검색 결과가 없습니다.</p>
          <button id="reset-filters">전체 글 보기</button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<!-- Client-side JavaScript for filtering -->
<script define:vars={{ postsData, categoryLabels }}>
  document.addEventListener('DOMContentLoaded', () => {
    const posts = postsData;
    let currentFilters = {
      category: '',
      series: '',
      tag: '',
      search: '',
    };

    // DOM Elements
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const categoryFilter = document.getElementById('category-filter');
    const seriesFilter = document.getElementById('series-filter');
    const tagFilter = document.getElementById('tag-filter');
    const activeFilters = document.getElementById('active-filters');
    const filterBadges = document.getElementById('filter-badges');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const groupedView = document.getElementById('grouped-view');
    const filteredView = document.getElementById('filtered-view');
    const emptyState = document.getElementById('empty-state');

    // Read URL params on load
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('category')) currentFilters.category = urlParams.get('category');
    if (urlParams.get('series')) currentFilters.series = urlParams.get('series');
    if (urlParams.get('tag')) currentFilters.tag = urlParams.get('tag');
    if (urlParams.get('q')) {
      currentFilters.search = urlParams.get('q');
      searchInput.value = currentFilters.search;
    }

    // Apply initial filters
    applyFilters();

    // Search
    searchBtn.addEventListener('click', () => {
      currentFilters.search = searchInput.value.trim();
      applyFilters();
    });

    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        currentFilters.search = searchInput.value.trim();
        applyFilters();
      }
    });

    // Category filter
    categoryFilter.addEventListener('click', (e) => {
      if (e.target.classList.contains('category-btn')) {
        currentFilters.category = e.target.dataset.category;
        currentFilters.series = ''; // Reset series when category changes
        applyFilters();
      }
    });

    // Series filter
    seriesFilter.addEventListener('click', (e) => {
      const btn = e.target.closest('.series-btn');
      if (btn) {
        currentFilters.series = btn.dataset.series;
        currentFilters.category = ''; // Reset category when series is selected
        applyFilters();
      }
    });

    // View all buttons in grouped view
    document.querySelectorAll('.view-all').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        currentFilters.series = btn.dataset.series;
        currentFilters.category = '';
        applyFilters();
      });
    });

    // Tag filter
    tagFilter.addEventListener('click', (e) => {
      if (e.target.classList.contains('tag-item')) {
        const tag = e.target.dataset.tag;
        currentFilters.tag = currentFilters.tag === tag ? '' : tag;
        applyFilters();
      }
    });

    // Clear filters
    clearFiltersBtn.addEventListener('click', clearAllFilters);
    resetFiltersBtn.addEventListener('click', clearAllFilters);

    function clearAllFilters() {
      currentFilters = { category: '', series: '', tag: '', search: '' };
      searchInput.value = '';
      applyFilters();
    }

    function applyFilters() {
      // Update URL
      const params = new URLSearchParams();
      if (currentFilters.category) params.set('category', currentFilters.category);
      if (currentFilters.series) params.set('series', currentFilters.series);
      if (currentFilters.tag) params.set('tag', currentFilters.tag);
      if (currentFilters.search) params.set('q', currentFilters.search);
      
      const newUrl = params.toString() ? `/blog?${params.toString()}` : '/blog';
      window.history.replaceState({}, '', newUrl);

      // Update UI
      updateFilterUI();

      // Check if any filter is active
      const hasFilter = currentFilters.category || currentFilters.series || currentFilters.tag || currentFilters.search;

      if (!hasFilter) {
        // Show grouped view
        groupedView.style.display = 'flex';
        filteredView.style.display = 'none';
        emptyState.style.display = 'none';
        activeFilters.style.display = 'none';
        return;
      }

      // Filter posts
      let filtered = posts.filter(post => {
        if (currentFilters.category && post.category !== currentFilters.category) return false;
        if (currentFilters.series && post.series !== currentFilters.series) return false;
        if (currentFilters.tag && !post.tags.includes(currentFilters.tag)) return false;
        if (currentFilters.search) {
          const query = currentFilters.search.toLowerCase();
          const matchTitle = post.title.toLowerCase().includes(query);
          const matchSummary = post.summary.toLowerCase().includes(query);
          const matchTags = post.tags.some(t => t.toLowerCase().includes(query));
          if (!matchTitle && !matchSummary && !matchTags) return false;
        }
        return true;
      });

      // Show/hide views
      groupedView.style.display = 'none';
      
      if (filtered.length === 0) {
        filteredView.style.display = 'none';
        emptyState.style.display = 'block';
      } else {
        filteredView.style.display = 'grid';
        emptyState.style.display = 'none';
        renderFilteredPosts(filtered);
      }

      // Show active filters
      activeFilters.style.display = 'flex';
      renderFilterBadges();
    }

    function updateFilterUI() {
      // Update category buttons
      categoryFilter.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === currentFilters.category && !currentFilters.series);
      });

      // Update series buttons
      seriesFilter.querySelectorAll('.series-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.series === currentFilters.series);
      });

      // Update tag buttons
      tagFilter.querySelectorAll('.tag-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tag === currentFilters.tag);
      });
    }

    function renderFilterBadges() {
      let badges = '';
      if (currentFilters.category) {
        const label = categoryLabels[currentFilters.category] || currentFilters.category;
        badges += `<span class="filter-badge">카테고리: ${label}</span>`;
      }
      if (currentFilters.series) {
        badges += `<span class="filter-badge">시리즈: ${currentFilters.series}</span>`;
      }
      if (currentFilters.tag) {
        badges += `<span class="filter-badge">태그: ${currentFilters.tag}</span>`;
      }
      if (currentFilters.search) {
        badges += `<span class="filter-badge">검색: "${currentFilters.search}"</span>`;
      }
      filterBadges.innerHTML = badges;
    }

    function renderFilteredPosts(filtered) {
      const html = filtered.map(post => {
        const date = new Date(post.date).toLocaleDateString('ko-KR', { 
          year: 'numeric', month: 'long', day: 'numeric' 
        });
        const categoryLabel = categoryLabels[post.category] || post.category;
        const tagsHtml = post.tags.slice(0, 3).map(tag => 
          `<span class="card-tag">#${tag}</span>`
        ).join('');

        return `
          <article class="blog-card">
            <a href="/blog/${post.slug}" class="card-link">
              <div class="card-content">
                <div class="card-meta">
                  <span class="card-category" data-category="${post.category}">${categoryLabel}</span>
                  <time datetime="${post.date}">${date}</time>
                </div>
                <h3 class="card-title">${post.title}</h3>
                <p class="card-summary">${post.summary}</p>
                <div class="card-tags">${tagsHtml}</div>
              </div>
            </a>
          </article>
        `;
      }).join('');

      filteredView.innerHTML = html;
    }
  });
</script>

<style>
  .section {
    padding: var(--space-12) 0 var(--space-20);
  }

  .page-header {
    margin-bottom: var(--space-8);
  }

  .page-title {
    font-size: var(--text-4xl);
    font-weight: 700;
    margin-bottom: var(--space-4);
  }

  .page-desc {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Search */
  .search-box {
    margin-bottom: var(--space-6);
  }

  .search-form {
    display: flex;
    max-width: 400px;
  }

  .search-input {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-base);
    border: 1px solid var(--color-border);
    border-right: none;
    border-radius: var(--radius-md) 0 0 var(--radius-md);
    background-color: var(--color-bg-alt);
    color: var(--color-text);
    outline: none;
  }

  .search-input:focus {
    border-color: var(--color-accent);
  }

  .search-btn {
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-accent);
    color: white;
    border: none;
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    cursor: pointer;
    transition: background-color var(--transition-fast);
  }

  .search-btn:hover {
    background-color: var(--color-accent-hover);
  }

  /* Category Filter */
  .category-filter {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
  }

  .category-btn {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .category-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .category-btn.active {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  /* Series Filter */
  .series-filter {
    margin-bottom: var(--space-6);
  }

  .filter-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
  }

  .series-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-3);
  }

  .series-btn {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    color: var(--color-text);
    transition: all var(--transition-fast);
    text-align: left;
  }

  .series-btn:hover {
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  .series-btn.active {
    border-color: var(--color-accent);
    background-color: var(--color-accent-light);
  }

  .series-btn[data-category="cs"] .series-icon {
    color: #0369a1;
  }

  .series-btn[data-category="book"] .series-icon {
    color: #b45309;
  }

  .series-btn .series-icon {
    font-size: var(--text-lg);
  }

  .series-btn .series-name {
    flex: 1;
    font-size: var(--text-sm);
    font-weight: 500;
  }

  .series-btn .series-count {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    background-color: var(--color-bg);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
  }

  /* Tag Filter */
  .tag-filter {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }

  .tag-filter .filter-label {
    display: inline;
    margin-bottom: 0;
  }

  .tag-list {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .tag-item {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .tag-item:hover {
    color: var(--color-accent);
    background-color: var(--color-accent-light);
  }

  .tag-item.active {
    background-color: var(--color-accent);
    color: white;
  }

  /* Active Filters */
  .active-filters {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background-color: var(--color-accent-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    font-size: var(--text-sm);
  }

  .filter-badge {
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-bg-alt);
    border-radius: var(--radius-sm);
  }

  .clear-all {
    color: var(--color-accent);
    background: none;
    border: none;
    cursor: pointer;
    margin-left: auto;
    font-size: var(--text-sm);
  }

  .clear-all:hover {
    text-decoration: underline;
  }

  /* Series Sections (Grouped View) */
  .series-sections {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
  }

  .series-section {
    padding: var(--space-6);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }

  .series-section[data-category="cs"] {
    border-left: 4px solid #0369a1;
  }

  .series-section[data-category="book"] {
    border-left: 4px solid #b45309;
  }

  .series-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .series-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xl);
    font-weight: 600;
    margin: 0;
  }

  .series-title .series-icon {
    font-size: var(--text-2xl);
  }

  .series-meta {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .post-count {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .view-all {
    font-size: var(--text-sm);
    color: var(--color-accent);
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 500;
  }

  .view-all:hover {
    text-decoration: underline;
  }

  .series-posts {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-4);
  }

  /* Blog Card */
  .blog-card {
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: all var(--transition-fast);
  }

  .blog-card:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .card-content {
    padding: var(--space-4);
  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }

  .card-category {
    font-size: var(--text-xs);
    font-weight: 500;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .card-category[data-category="cs"] {
    background-color: #e0f2fe;
    color: #0369a1;
  }

  .card-category[data-category="book"] {
    background-color: #fef3c7;
    color: #b45309;
  }

  .card-category[data-category="til"] {
    background-color: #fee2e2;
    color: #dc2626;
  }

  @media (prefers-color-scheme: dark) {
    .card-category[data-category="cs"] {
      background-color: #0c4a6e;
      color: #7dd3fc;
    }

    .card-category[data-category="book"] {
      background-color: #78350f;
      color: #fcd34d;
    }

    .card-category[data-category="til"] {
      background-color: #7f1d1d;
      color: #fca5a5;
    }
  }

  .card-meta time {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .card-title {
    font-size: var(--text-base);
    font-weight: 600;
    margin: 0 0 var(--space-2);
    line-height: 1.4;
  }

  .card-summary {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0 0 var(--space-3);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-tags {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .card-tag {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  /* Grid */
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-6);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-16) 0;
    color: var(--color-text-muted);
  }

  .empty-state button {
    color: var(--color-accent);
    background: none;
    border: none;
    cursor: pointer;
    margin-top: var(--space-4);
    font-size: var(--text-base);
  }

  .empty-state button:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .blog-grid {
      grid-template-columns: 1fr;
    }

    .series-posts {
      grid-template-columns: 1fr;
    }

    .series-list {
      grid-template-columns: 1fr;
    }

    .search-form {
      max-width: none;
    }

    .series-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
